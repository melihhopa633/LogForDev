@{
    ViewData["Title"] = "Dashboard";
    var projects = ViewBag.Projects as List<Project> ?? new List<Project>();
}

<!-- Toast Container -->
<div id="toastContainer" class="fixed top-16 right-4 z-[100] space-y-2"></div>

<!-- Filters -->
<div class="rounded-xl border border-border bg-card p-5 mb-4">
    <!-- Row 1: Level toggles + Time range + Project + Actions -->
    <div class="flex flex-wrap items-center gap-3">
        <!-- Level Toggle Buttons -->
        <div class="flex items-center gap-1.5 mr-1">
            <button class="level-toggle h-9 rounded-lg border border-border bg-background px-3.5 text-xs font-semibold text-zinc-400 hover:bg-secondary transition-all" data-level="Trace">TRC</button>
            <button class="level-toggle h-9 rounded-lg border border-border bg-background px-3.5 text-xs font-semibold text-blue-400 hover:bg-blue-500/10 transition-all" data-level="Debug">DBG</button>
            <button class="level-toggle h-9 rounded-lg border border-border bg-background px-3.5 text-xs font-semibold text-green-400 hover:bg-green-500/10 transition-all" data-level="Info">INF</button>
            <button class="level-toggle h-9 rounded-lg border border-border bg-background px-3.5 text-xs font-semibold text-yellow-400 hover:bg-yellow-500/10 transition-all" data-level="Warning">WRN</button>
            <button class="level-toggle h-9 rounded-lg border border-border bg-background px-3.5 text-xs font-semibold text-red-400 hover:bg-red-500/10 transition-all" data-level="Error">ERR</button>
            <button class="level-toggle h-9 rounded-lg border border-border bg-background px-3.5 text-xs font-semibold text-red-300 hover:bg-red-600/10 transition-all" data-level="Fatal">FTL</button>
        </div>

        <div class="w-px h-6 bg-border hidden lg:block"></div>

        <!-- Time Range -->
        <div class="flex items-center gap-1.5" id="timeRangeButtons">
            <button onclick="setTimeRange(1)" class="time-range-btn h-9 rounded-lg border border-border bg-background px-3.5 text-xs font-medium text-foreground hover:bg-secondary transition-colors" data-hours="1">1h</button>
            <button onclick="setTimeRange(6)" class="time-range-btn h-9 rounded-lg border border-border bg-background px-3.5 text-xs font-medium text-foreground hover:bg-secondary transition-colors" data-hours="6">6h</button>
            <button onclick="setTimeRange(24)" class="time-range-btn h-9 rounded-lg border border-border bg-background px-3.5 text-xs font-medium text-foreground hover:bg-secondary transition-colors" data-hours="24">24h</button>
            <button onclick="setTimeRange(168)" class="time-range-btn h-9 rounded-lg border border-border bg-background px-3.5 text-xs font-medium text-foreground hover:bg-secondary transition-colors" data-hours="168">7d</button>
            <button onclick="setTimeRange(0)" class="time-range-btn h-9 rounded-lg border border-border bg-background px-3.5 text-xs font-medium text-muted-foreground hover:bg-secondary transition-colors active-time-range" data-hours="0">All</button>
            <button onclick="toggleCustomRange()" id="customRangeBtn" class="time-range-btn h-9 rounded-lg border border-border bg-background px-3 text-xs font-medium text-muted-foreground hover:bg-secondary transition-colors">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            </button>
        </div>

        <div class="w-px h-6 bg-border hidden lg:block"></div>

        <!-- Project -->
        <select id="projectFilter" class="h-9 rounded-lg border border-input bg-background px-3 text-xs text-foreground focus:outline-none focus:ring-2 focus:ring-ring min-w-[130px]">
            <option value="">All Projects</option>
            @foreach (var project in projects)
            {
                var suffix = project.IsExpired ? " (expired)" : "";
                <option value="@project.Id">@project.Name@suffix</option>
            }
        </select>

        <!-- Spacer -->
        <div class="flex-1"></div>

        <!-- Actions -->
        <div class="flex items-center gap-2">
            <button id="refreshBtn" class="h-9 rounded-lg bg-primary px-4 text-xs font-medium text-primary-foreground hover:bg-primary/90 transition-colors flex items-center gap-2">
                <svg id="refreshIcon" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
                Refresh
            </button>
            <button id="liveToggle" class="h-9 rounded-lg border border-green-500/50 px-4 text-xs font-medium text-green-500 hover:bg-green-500/10 transition-colors flex items-center gap-2">
                <span class="relative flex h-2 w-2">
                    <span id="liveDot" class="absolute inline-flex h-full w-full rounded-full opacity-0 bg-green-400"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                LIVE
            </button>
            <button onclick="openShortcutsModal()" class="h-9 w-9 rounded-lg border border-border bg-background text-muted-foreground hover:text-foreground hover:bg-secondary transition-colors flex items-center justify-center" title="Keyboard shortcuts (?)">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            </button>
        </div>
    </div>

    <!-- Row 2: Search + Trace + Actions -->
    <div class="flex flex-col lg:flex-row gap-3 items-center mt-4 pt-4 border-t border-border/50">
        <div class="relative flex-1 w-full">
            <svg class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            <input type="text" id="searchFilter" placeholder="Search messages..."
                class="h-9 rounded-lg border border-input bg-background pl-10 pr-3 text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring w-full" />
        </div>
        <input type="text" id="traceIdFilter" placeholder="Trace ID..."
            class="h-9 rounded-lg border border-input bg-background px-3.5 text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring w-full lg:w-[220px] font-mono" />
        <button id="clearFilters" class="h-9 rounded-lg border border-border bg-background px-4 text-xs font-medium text-muted-foreground hover:text-foreground hover:bg-secondary transition-colors whitespace-nowrap">
            Clear
        </button>
        <div class="relative">
            <button onclick="toggleDeleteMenu()" class="h-9 rounded-lg border border-red-500/30 bg-red-500/10 px-4 text-xs font-medium text-red-500 hover:bg-red-500/20 transition-colors whitespace-nowrap flex items-center gap-2">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                Delete
            </button>
            <div id="deleteMenu" class="hidden absolute right-0 top-full mt-1 w-56 rounded-lg border border-border bg-card shadow-lg z-50 p-2 space-y-0.5">
                <button onclick="deleteLogs(null)" class="w-full text-left px-3 py-2 text-xs rounded-md hover:bg-red-500/10 text-red-400 hover:text-red-300 transition-colors">Delete All</button>
                <button onclick="deleteLogs(1)" class="w-full text-left px-3 py-2 text-xs rounded-md hover:bg-secondary text-foreground transition-colors">Older than 1 day</button>
                <button onclick="deleteLogs(7)" class="w-full text-left px-3 py-2 text-xs rounded-md hover:bg-secondary text-foreground transition-colors">Older than 7 days</button>
                <button onclick="deleteLogs(15)" class="w-full text-left px-3 py-2 text-xs rounded-md hover:bg-secondary text-foreground transition-colors">Older than 15 days</button>
                <button onclick="deleteLogs(30)" class="w-full text-left px-3 py-2 text-xs rounded-md hover:bg-secondary text-foreground transition-colors">Older than 30 days</button>
            </div>
        </div>
    </div>

    <!-- Custom Date Range (hidden by default) -->
    <div id="customRangeRow" class="hidden flex-col lg:flex-row gap-3 items-end mt-4 pt-4 border-t border-border/50">
        <div class="flex flex-col gap-1 w-full lg:w-auto">
            <label class="text-[11px] font-medium text-muted-foreground">From</label>
            <input type="datetime-local" id="fromFilter" class="h-9 rounded-lg border border-input bg-background px-3.5 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring" />
        </div>
        <div class="flex flex-col gap-1 w-full lg:w-auto">
            <label class="text-[11px] font-medium text-muted-foreground">To</label>
            <input type="datetime-local" id="toFilter" class="h-9 rounded-lg border border-input bg-background px-3.5 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring" />
        </div>
    </div>

    <!-- Active Filter Tags -->
    <div id="activeFilters" class="hidden flex-wrap gap-2 pt-4 mt-4 border-t border-border/50"></div>
</div>

<!-- Bulk Actions Bar -->
<div id="bulkActionsBar" class="hidden rounded-xl border border-primary/50 bg-primary/10 p-3 mb-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
        <span class="text-sm font-medium"><span id="selectedCount">0</span> logs selected</span>
        <button onclick="selectAllOnPage()" class="text-xs text-primary hover:underline">Select all on page</button>
        <button onclick="clearSelection()" class="text-xs text-muted-foreground hover:text-foreground">Clear selection</button>
    </div>
    <div class="flex items-center gap-2">
        <button onclick="copySelectedAsJson()" class="h-8 rounded-md bg-primary px-3 text-xs font-medium text-primary-foreground hover:bg-primary/90 transition-colors flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
            Copy JSON
        </button>
        <button onclick="copySelectedAsCsv()" class="h-8 rounded-md border border-border bg-background px-3 text-xs font-medium text-foreground hover:bg-secondary transition-colors flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
            Copy CSV
        </button>
        <button onclick="downloadSelectedAsJson()" class="h-8 rounded-md border border-border bg-background px-3 text-xs font-medium text-foreground hover:bg-secondary transition-colors flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
            Download
        </button>
    </div>
</div>

<!-- Logs Table -->
<div class="rounded-xl border border-border overflow-hidden mb-4">
    <div class="overflow-x-auto scrollbar-thin">
        <table class="w-full text-sm">
            <thead>
                <tr class="border-b border-border bg-muted/30">
                    <th class="h-10 px-3 text-center w-[40px]">
                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" class="rounded border-input">
                    </th>
                    <th class="h-10 px-4 text-left font-medium text-muted-foreground text-xs uppercase tracking-wider w-[170px]">Timestamp</th>
                    <th class="h-10 px-4 text-left font-medium text-muted-foreground text-xs uppercase tracking-wider w-[90px]">Level</th>
                    <th class="h-10 px-4 text-left font-medium text-muted-foreground text-xs uppercase tracking-wider w-[130px]">Project</th>
                    <th class="h-10 px-4 text-left font-medium text-muted-foreground text-xs uppercase tracking-wider">Message</th>
                    <th class="h-10 px-4 text-left font-medium text-muted-foreground text-xs uppercase tracking-wider w-[50px]"></th>
                </tr>
            </thead>
            <tbody id="logsBody">
                <tr>
                    <td colspan="5" class="h-32 text-center">
                        <div class="flex flex-col items-center gap-2 text-muted-foreground">
                            <svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                            <span class="text-sm">Loading logs...</span>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<div class="flex flex-col sm:flex-row items-center justify-between gap-3 mb-6">
    <div class="flex items-center gap-2">
        <span class="text-xs text-muted-foreground">Rows per page</span>
        <select id="pageSizeSelect" class="h-8 rounded-md border border-input bg-background px-2 text-xs text-foreground focus:outline-none focus:ring-2 focus:ring-ring min-w-[65px]">
            <option value="25">25</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
        </select>
        <span id="pageInfo" class="text-xs text-muted-foreground ml-2">Page 1 of 1</span>
    </div>
    <div class="flex items-center gap-1" id="paginationControls">
        <button id="firstPage" class="h-8 w-8 rounded-md border border-border bg-background text-xs font-medium text-foreground hover:bg-secondary transition-colors disabled:opacity-30 disabled:cursor-not-allowed flex items-center justify-center" disabled title="First page">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m11 17-5-5 5-5"/><path d="m18 17-5-5 5-5"/></svg>
        </button>
        <button id="prevPage" class="h-8 w-8 rounded-md border border-border bg-background text-xs font-medium text-foreground hover:bg-secondary transition-colors disabled:opacity-30 disabled:cursor-not-allowed flex items-center justify-center" disabled title="Previous page">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
        </button>
        <div id="pageNumbers" class="flex items-center gap-1"></div>
        <button id="nextPage" class="h-8 w-8 rounded-md border border-border bg-background text-xs font-medium text-foreground hover:bg-secondary transition-colors disabled:opacity-30 disabled:cursor-not-allowed flex items-center justify-center" title="Next page">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
        </button>
        <button id="lastPage" class="h-8 w-8 rounded-md border border-border bg-background text-xs font-medium text-foreground hover:bg-secondary transition-colors disabled:opacity-30 disabled:cursor-not-allowed flex items-center justify-center" title="Last page">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 17 5-5-5-5"/><path d="m13 17 5-5-5-5"/></svg>
        </button>
    </div>
</div>

<!-- Trace Timeline Modal -->
<div id="traceModal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" onclick="closeTraceModal()"></div>
    <div class="relative z-50 w-full max-w-4xl max-h-[85vh] overflow-auto rounded-xl border border-border bg-background p-6 shadow-2xl mx-4 scrollbar-thin">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Trace Timeline</h3>
            <button onclick="closeTraceModal()" class="rounded-md p-1 opacity-70 hover:opacity-100 hover:bg-secondary transition-all">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div id="traceDetails" class="space-y-4"></div>
    </div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div id="shortcutsModal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" onclick="closeShortcutsModal()"></div>
    <div class="relative z-50 w-full max-w-md rounded-xl border border-border bg-background p-6 shadow-2xl mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Keyboard Shortcuts</h3>
            <button onclick="closeShortcutsModal()" class="rounded-md p-1 opacity-70 hover:opacity-100 hover:bg-secondary transition-all">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="space-y-4">
            <div>
                <p class="text-xs font-medium text-muted-foreground uppercase tracking-wider mb-2">Navigation</p>
                <div class="space-y-1.5">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">Previous page</span>
                        <kbd class="px-2 py-0.5 rounded bg-muted border border-border text-xs font-mono">←</kbd>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">Next page</span>
                        <kbd class="px-2 py-0.5 rounded bg-muted border border-border text-xs font-mono">→</kbd>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">Refresh logs</span>
                        <kbd class="px-2 py-0.5 rounded bg-muted border border-border text-xs font-mono">r</kbd>
                    </div>
                </div>
            </div>
            <div class="border-t border-border pt-4">
                <p class="text-xs font-medium text-muted-foreground uppercase tracking-wider mb-2">Actions</p>
                <div class="space-y-1.5">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">Focus search</span>
                        <kbd class="px-2 py-0.5 rounded bg-muted border border-border text-xs font-mono">/</kbd>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">Toggle live mode</span>
                        <kbd class="px-2 py-0.5 rounded bg-muted border border-border text-xs font-mono">l</kbd>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">Clear filters</span>
                        <kbd class="px-2 py-0.5 rounded bg-muted border border-border text-xs font-mono">c</kbd>
                    </div>
                </div>
            </div>
            <div class="border-t border-border pt-4">
                <p class="text-xs font-medium text-muted-foreground uppercase tracking-wider mb-2">Filter by Level</p>
                <div class="grid grid-cols-2 gap-1.5">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">Errors only</span>
                        <kbd class="px-2 py-0.5 rounded bg-muted border border-border text-xs font-mono">e</kbd>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">Warnings only</span>
                        <kbd class="px-2 py-0.5 rounded bg-muted border border-border text-xs font-mono">w</kbd>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">Info only</span>
                        <kbd class="px-2 py-0.5 rounded bg-muted border border-border text-xs font-mono">i</kbd>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">All levels</span>
                        <kbd class="px-2 py-0.5 rounded bg-muted border border-border text-xs font-mono">a</kbd>
                    </div>
                </div>
            </div>
            <div class="border-t border-border pt-4">
                <p class="text-xs font-medium text-muted-foreground uppercase tracking-wider mb-2">Modals</p>
                <div class="space-y-1.5">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">Show this help</span>
                        <kbd class="px-2 py-0.5 rounded bg-muted border border-border text-xs font-mono">?</kbd>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">Close modal</span>
                        <kbd class="px-2 py-0.5 rounded bg-muted border border-border text-xs font-mono">Esc</kbd>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Detail Modal -->
<div id="logModal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
    <div class="relative z-50 w-full max-w-2xl max-h-[85vh] overflow-auto rounded-xl border border-border bg-background p-6 shadow-2xl mx-4 scrollbar-thin">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Log Details</h3>
            <button onclick="closeModal()" class="rounded-md p-1 opacity-70 hover:opacity-100 hover:bg-secondary transition-all">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div id="logDetails" class="space-y-3"></div>
    </div>
</div>

@section Scripts {
    <style>
        .level-toggle.active { font-weight: 700; }
        .active-time-range {
            background-color: rgb(37 99 235 / 0.15) !important;
            border-color: rgb(37 99 235 / 0.5) !important;
            color: rgb(96 165 250) !important;
        }
        .log-row { cursor: pointer; }
        .log-row:nth-child(4n+1), .log-row:nth-child(4n+2) { background-color: rgba(39, 39, 42, 0.15); }
        .log-row:hover { background-color: rgba(39, 39, 42, 0.4) !important; }
        .expand-row { display: none; }
        .expand-row.open { display: table-row; }
        .expand-row td { padding: 0 !important; }
        .expand-content { animation: slideDown 0.2s ease-out; }
        @@keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }
        .page-btn { min-width: 2rem; }
        .page-btn.active { background-color: rgb(37 99 235) !important; color: white !important; border-color: rgb(37 99 235) !important; }
        .refresh-spin { animation: spin 0.7s linear infinite; }
        @@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let totalCount = 0;
        let pageSize = 50;
        let isLive = false;
        let liveInterval = null;
        let expandedRow = null;

        // --- Utility ---
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function relativeTime(dateStr) {
            const now = new Date();
            const d = new Date(dateStr);
            const diff = Math.floor((now - d) / 1000);
            if (diff < 60) return `${diff}s ago`;
            if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
            return `${Math.floor(diff/86400)}d ago`;
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        // --- URL State Management ---
        function updateUrlState() {
            const params = new URLSearchParams();

            const levels = getSelectedLevels();
            if (levels.length > 0) params.set('levels', levels.join(','));

            const projectId = document.getElementById('projectFilter').value;
            if (projectId) params.set('projectId', projectId);

            const search = document.getElementById('searchFilter').value;
            if (search) params.set('search', search);

            const traceId = document.getElementById('traceIdFilter').value;
            if (traceId) params.set('traceId', traceId);

            const from = document.getElementById('fromFilter').value;
            if (from) params.set('from', from);

            const to = document.getElementById('toFilter').value;
            if (to) params.set('to', to);

            if (currentPage > 1) params.set('page', currentPage);
            if (pageSize !== 50) params.set('pageSize', pageSize);

            const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
            window.history.replaceState({}, '', newUrl);
        }

        function loadStateFromUrl() {
            const params = new URLSearchParams(window.location.search);

            // Levels
            const levels = params.get('levels');
            if (levels) {
                const levelArr = levels.split(',');
                document.querySelectorAll('.level-toggle').forEach(btn => {
                    const level = btn.dataset.level;
                    if (levelArr.includes(level)) {
                        btn.classList.add('active');
                        const colors = levelColors[level];
                        colors.active.split(' ').forEach(c => btn.classList.add(c));
                        btn.classList.remove('bg-background');
                    }
                });
            }

            // Project
            const projectId = params.get('projectId');
            if (projectId) document.getElementById('projectFilter').value = projectId;

            // Search
            const search = params.get('search');
            if (search) document.getElementById('searchFilter').value = search;

            // Trace ID
            const traceId = params.get('traceId');
            if (traceId) document.getElementById('traceIdFilter').value = traceId;

            // From/To
            const from = params.get('from');
            if (from) document.getElementById('fromFilter').value = from;

            const to = params.get('to');
            if (to) document.getElementById('toFilter').value = to;

            // Page
            const page = params.get('page');
            if (page) currentPage = parseInt(page) || 1;

            // Page Size
            const ps = params.get('pageSize');
            if (ps) {
                pageSize = parseInt(ps) || 50;
                document.getElementById('pageSizeSelect').value = pageSize;
            }

            // Show custom date range row if custom dates are set
            if (from || to) {
                document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active-time-range'));
                const customRow = document.getElementById('customRangeRow');
                customRow.classList.remove('hidden');
                customRow.classList.add('flex');
                document.getElementById('customRangeBtn').classList.add('active-time-range');
            }
        }

        // Handle browser back/forward
        window.addEventListener('popstate', () => {
            loadStateFromUrl();
            loadLogs(false); // false = don't update URL again
        });

        // --- Toast ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const colors = {
                info: 'border-primary/50 bg-primary/10 text-blue-300',
                error: 'border-red-500/50 bg-red-500/10 text-red-300',
                success: 'border-green-500/50 bg-green-500/10 text-green-300'
            };
            const toast = document.createElement('div');
            toast.className = `rounded-lg border px-4 py-3 text-sm shadow-lg ${colors[type] || colors.info} transition-all duration-300 transform translate-x-0`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- Level Badges ---
        const levelNames = ['Trace', 'Debug', 'Info', 'Warning', 'Error', 'Fatal'];
        function levelBadge(level) {
            // Convert numeric level to string if needed
            const levelStr = typeof level === 'number' ? (levelNames[level] || 'Unknown') : level;
            const map = {
                trace:   'bg-zinc-700/50 text-zinc-400',
                debug:   'bg-blue-500/20 text-blue-400',
                info:    'bg-green-500/20 text-green-400',
                warning: 'bg-yellow-500/20 text-yellow-400',
                error:   'bg-red-500/20 text-red-400',
                fatal:   'bg-red-600 text-white',
            };
            const cls = map[levelStr.toLowerCase()] || 'bg-zinc-700/50 text-zinc-400';
            return `<span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-semibold uppercase ${cls}">${levelStr}</span>`;
        }

        function envBadge(env) {
            if (!env) return '<span class="text-muted-foreground text-xs">-</span>';
            const map = {
                production: 'bg-red-500/10 text-red-400 border-red-500/20',
                staging: 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20',
                development: 'bg-green-500/10 text-green-400 border-green-500/20',
                dev: 'bg-green-500/10 text-green-400 border-green-500/20',
            };
            const cls = map[env.toLowerCase()] || 'bg-zinc-700/30 text-zinc-400 border-zinc-600/30';
            return `<span class="inline-flex items-center rounded px-1.5 py-0.5 text-[10px] font-medium border ${cls}">${escapeHtml(env)}</span>`;
        }

        // --- Level Toggle Buttons ---
        const levelColors = {
            Trace:   { active: 'bg-zinc-700/60 border-zinc-500/50 text-zinc-300', ring: '' },
            Debug:   { active: 'bg-blue-500/20 border-blue-500/50 text-blue-300', ring: '' },
            Info:    { active: 'bg-green-500/20 border-green-500/50 text-green-300', ring: '' },
            Warning: { active: 'bg-yellow-500/20 border-yellow-500/50 text-yellow-300', ring: '' },
            Error:   { active: 'bg-red-500/20 border-red-500/50 text-red-300', ring: '' },
            Fatal:   { active: 'bg-red-600/30 border-red-500/50 text-red-200', ring: '' },
        };

        function getSelectedLevels() {
            const active = document.querySelectorAll('.level-toggle.active');
            return [...active].map(b => b.dataset.level);
        }

        document.querySelectorAll('.level-toggle').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('active');
                const level = btn.dataset.level;
                const colors = levelColors[level];
                if (btn.classList.contains('active')) {
                    colors.active.split(' ').forEach(c => btn.classList.add(c));
                    btn.classList.remove('bg-background');
                } else {
                    colors.active.split(' ').forEach(c => btn.classList.remove(c));
                    btn.classList.add('bg-background');
                }
                currentPage = 1;
                loadLogs();
            });
        });

        // --- Time Range ---
        function setTimeRange(hours) {
            const fromEl = document.getElementById('fromFilter');
            const toEl = document.getElementById('toFilter');
            if (hours === 0) {
                fromEl.value = '';
                toEl.value = '';
            } else {
                const now = new Date();
                const from = new Date(now.getTime() - hours * 60 * 60 * 1000);
                toEl.value = toLocalISOString(now);
                fromEl.value = toLocalISOString(from);
            }
            // highlight active button
            document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active-time-range'));
            const activeBtn = document.querySelector(`.time-range-btn[data-hours="${hours}"]`);
            if (activeBtn) activeBtn.classList.add('active-time-range');

            // Hide custom range row
            const customRow = document.getElementById('customRangeRow');
            customRow.classList.add('hidden');
            customRow.classList.remove('flex');

            currentPage = 1;
            loadLogs();
        }

        function toLocalISOString(date) {
            const pad = n => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        // --- Toggle Custom Date Range ---
        function toggleCustomRange() {
            const row = document.getElementById('customRangeRow');
            const btn = document.getElementById('customRangeBtn');
            if (row.classList.contains('hidden')) {
                row.classList.remove('hidden');
                row.classList.add('flex');
                btn.classList.add('active-time-range');
                document.querySelectorAll('.time-range-btn:not(#customRangeBtn)').forEach(b => b.classList.remove('active-time-range'));
            } else {
                row.classList.add('hidden');
                row.classList.remove('flex');
                btn.classList.remove('active-time-range');
                document.getElementById('fromFilter').value = '';
                document.getElementById('toFilter').value = '';
                document.querySelector('.time-range-btn[data-hours="0"]').classList.add('active-time-range');
                currentPage = 1;
                loadLogs();
            }
        }

        // --- Active Filter Tags ---
        function updateActiveFilters() {
            const container = document.getElementById('activeFilters');
            const tags = [];
            const levels = getSelectedLevels();
            if (levels.length > 0) tags.push({ label: `Level: ${levels.join(', ')}`, clear: () => { document.querySelectorAll('.level-toggle').forEach(btn => { btn.classList.remove('active'); const colors = levelColors[btn.dataset.level]; colors.active.split(' ').forEach(c => btn.classList.remove(c)); btn.classList.add('bg-background'); }); }});
            const search = document.getElementById('searchFilter').value;
            if (search) tags.push({ label: `Search: "${search}"`, clear: () => { document.getElementById('searchFilter').value = ''; }});
            const traceId = document.getElementById('traceIdFilter').value;
            if (traceId) tags.push({ label: `Trace: ${traceId.substring(0,12)}...`, clear: () => { document.getElementById('traceIdFilter').value = ''; }});

            if (tags.length === 0) {
                container.classList.add('hidden');
                container.classList.remove('flex');
                return;
            }
            container.classList.remove('hidden');
            container.classList.add('flex');
            container.innerHTML = tags.map((t, i) => `
                <span class="inline-flex items-center gap-1 rounded-md bg-primary/10 border border-primary/20 px-2 py-1 text-xs text-blue-300">
                    ${escapeHtml(t.label)}
                    <button onclick="clearFilterTag(${i})" class="hover:text-white transition-colors ml-0.5">&times;</button>
                </span>
            `).join('');
            // Store clear functions
            container._tags = tags;
        }

        function clearFilterTag(index) {
            const container = document.getElementById('activeFilters');
            if (container._tags && container._tags[index]) {
                container._tags[index].clear();
                currentPage = 1;
                loadLogs();
            }
        }

        // --- Delete Logs ---
        function toggleDeleteMenu() {
            document.getElementById('deleteMenu').classList.toggle('hidden');
        }
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('deleteMenu');
            if (!e.target.closest('.relative') || !e.target.closest('[onclick*="toggleDeleteMenu"]')) {
                if (!e.target.closest('#deleteMenu')) menu.classList.add('hidden');
            }
        });
        async function deleteLogs(days) {
            const msg = days ? `Logs older than ${days} days will be deleted. Are you sure?` : 'ALL logs will be deleted! Are you sure?';
            if (!confirm(msg)) return;
            document.getElementById('deleteMenu').classList.add('hidden');
            try {
                const url = days ? `/api/logs?olderThanDays=${days}` : '/api/logs';
                const resp = await fetch(url, { method: 'DELETE' });
                const data = await resp.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadLogs();
                } else {
                    showToast(data.error || 'Delete operation failed', 'error');
                }
            } catch (e) {
                showToast('Delete operation failed', 'error');
            }
        }

        // --- Load Logs ---
        async function loadLogs(shouldUpdateUrl = true) {
            const levels = getSelectedLevels();
            const projectId = document.getElementById('projectFilter').value;
            const search = document.getElementById('searchFilter').value;
            const traceId = document.getElementById('traceIdFilter').value;
            const from = document.getElementById('fromFilter').value;
            const to = document.getElementById('toFilter').value;

            let url = `/api/logs?page=${currentPage}&pageSize=${pageSize}`;
            if (levels.length > 0) url += `&levels=${encodeURIComponent(levels.join(','))}`;
            if (projectId) url += `&projectId=${encodeURIComponent(projectId)}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (traceId) url += `&traceId=${encodeURIComponent(traceId)}`;
            if (from) url += `&from=${encodeURIComponent(new Date(from).toISOString())}`;
            if (to) url += `&to=${encodeURIComponent(new Date(to).toISOString())}`;

            // Update browser URL
            if (shouldUpdateUrl) updateUrlState();

            // Show loading spinner on refresh button
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.classList.add('refresh-spin');

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const result = await response.json();
                totalCount = result.totalCount;
                totalPages = result.totalPages || 1;
                expandedRow = null;
                renderLogs(result.data);
                updatePagination();
                updateActiveFilters();
            } catch (error) {
                console.error('Failed to load logs:', error);
                showToast('Failed to load logs: ' + error.message, 'error');
            } finally {
                refreshIcon.classList.remove('refresh-spin');
            }
        }

        // --- Render Logs ---
        let currentLogs = []; // Store current logs for selection
        let selectedLogs = new Set(); // Track selected log IDs

        function renderLogs(logs) {
            const tbody = document.getElementById('logsBody');
            currentLogs = logs || [];
            document.getElementById('selectAllCheckbox').checked = false;
            updateBulkActionsBar();

            if (!logs || logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="h-32 text-center">
                            <div class="flex flex-col items-center gap-2 text-muted-foreground">
                                <svg class="w-8 h-8 opacity-30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                <span class="text-sm">No logs found</span>
                                <span class="text-xs">Try adjusting your filters</span>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            tbody.innerHTML = logs.map((log, i) => {
                const logJson = JSON.stringify(log).replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;');
                const isSelected = selectedLogs.has(log.id);
                return `
                <tr class="log-row border-b border-border/50 transition-colors ${isSelected ? 'bg-primary/10' : ''}" data-index="${i}" data-id="${log.id}">
                    <td class="px-3 py-2.5 text-center" onclick="event.stopPropagation()">
                        <input type="checkbox" class="log-checkbox rounded border-input" data-id="${log.id}" ${isSelected ? 'checked' : ''} onchange="toggleLogSelection(this, '${log.id}')">
                    </td>
                    <td class="px-4 py-2.5" onclick="toggleExpand(this.parentElement, ${i})">
                        <div class="font-mono text-xs text-muted-foreground">${formatDate(log.timestamp)}</div>
                        <div class="text-[10px] text-muted-foreground/60">${relativeTime(log.timestamp)}</div>
                    </td>
                    <td class="px-4 py-2.5" onclick="toggleExpand(this.parentElement, ${i})">${levelBadge(log.level)}</td>
                    <td class="px-4 py-2.5 font-mono text-xs text-purple-400" onclick="toggleExpand(this.parentElement, ${i})">${escapeHtml(log.projectName || log.appName || '-')}</td>
                    <td class="px-4 py-2.5 text-sm max-w-[400px]" onclick="toggleExpand(this.parentElement, ${i})"><span class="line-clamp-1">${escapeHtml(truncate(log.message, 120))}</span></td>
                    <td class="px-4 py-2.5 text-center" onclick="toggleExpand(this.parentElement, ${i})">
                        <svg class="w-4 h-4 text-muted-foreground transition-transform expand-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                    </td>
                </tr>
                <tr class="expand-row border-b border-border/30" data-expand="${i}">
                    <td colspan="6">
                        <div class="expand-content p-4 bg-muted/20">
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-3">
                                <div>
                                    <span class="text-[10px] text-muted-foreground uppercase tracking-wider">ID</span>
                                    <p class="font-mono text-xs mt-0.5 break-all">${log.id}</p>
                                </div>
                                <div>
                                    <span class="text-[10px] text-muted-foreground uppercase tracking-wider">App</span>
                                    <p class="font-mono text-xs mt-0.5 text-purple-400">${escapeHtml(log.appName || '-')}</p>
                                </div>
                                <div>
                                    <span class="text-[10px] text-muted-foreground uppercase tracking-wider">Environment</span>
                                    <p class="text-xs mt-0.5">${envBadge(log.environment)}</p>
                                </div>
                                <div>
                                    <span class="text-[10px] text-muted-foreground uppercase tracking-wider">Host</span>
                                    <p class="font-mono text-xs mt-0.5">${escapeHtml(log.host || '-')}</p>
                                </div>
                                <div>
                                    <span class="text-[10px] text-muted-foreground uppercase tracking-wider">Trace ID</span>
                                    <p class="font-mono text-xs mt-0.5 break-all">${escapeHtml(log.traceId || '-')}</p>
                                </div>
                            </div>
                            <div class="mb-3">
                                <span class="text-[10px] text-muted-foreground uppercase tracking-wider">Message</span>
                                <pre class="mt-1 rounded-lg bg-background/80 border border-border p-3 font-mono text-xs whitespace-pre-wrap break-words max-h-48 overflow-auto scrollbar-thin">${escapeHtml(log.message)}</pre>
                            </div>
                            ${log.metadata ? `
                            <div>
                                <span class="text-[10px] text-muted-foreground uppercase tracking-wider">Metadata</span>
                                <pre class="mt-1 rounded-lg bg-background/80 border border-border p-3 font-mono text-xs overflow-x-auto scrollbar-thin max-h-48">${formatMetadata(log.metadata)}</pre>
                            </div>` : ''}
                            <div class="flex gap-2 mt-3 pt-3 border-t border-border/30">
                                <button onclick="event.stopPropagation(); showDetail(${logJson})" class="h-7 rounded-md border border-border bg-background px-3 text-xs font-medium hover:bg-secondary transition-colors">
                                    Full View
                                </button>
                                <button onclick="event.stopPropagation(); copyToClipboard('${log.id}')" class="h-7 rounded-md border border-border bg-background px-3 text-xs font-medium hover:bg-secondary transition-colors">
                                    Copy ID
                                </button>
                                ${log.traceId ? `
                                <button onclick="event.stopPropagation(); filterByTrace('${escapeHtml(log.traceId)}')" class="h-7 rounded-md border border-border bg-background px-3 text-xs font-medium hover:bg-secondary transition-colors">Filter Trace</button>
                                <button onclick="event.stopPropagation(); viewTraceTimeline('${escapeHtml(log.traceId)}')" class="h-7 rounded-md bg-primary/10 border border-primary/30 px-3 text-xs font-medium text-primary hover:bg-primary/20 transition-colors">View Timeline</button>
                            ` : ''}
                            </div>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function formatMetadata(metadata) {
            try {
                const parsed = typeof metadata === 'string' ? JSON.parse(metadata) : metadata;
                return escapeHtml(JSON.stringify(parsed, null, 2));
            } catch {
                return escapeHtml(metadata);
            }
        }

        // --- Trace Timeline ---
        async function showTraceTimeline(traceId) {
            const modal = document.getElementById('traceModal');
            const details = document.getElementById('traceDetails');

            details.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <svg class="w-6 h-6 animate-spin text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                </div>`;

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            try {
                const response = await fetch(`/api/logs/trace/${encodeURIComponent(traceId)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const timeline = await response.json();
                renderTraceTimeline(timeline);
            } catch (error) {
                details.innerHTML = `<div class="text-center text-muted-foreground py-8">Failed to load trace: ${error.message}</div>`;
            }
        }

        function renderTraceTimeline(timeline) {
            const details = document.getElementById('traceDetails');

            const header = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4 rounded-lg bg-muted/30 border border-border">
                    <div>
                        <span class="text-xs text-muted-foreground uppercase tracking-wider">Trace ID</span>
                        <p class="font-mono text-xs mt-1 break-all">${escapeHtml(timeline.traceId)}</p>
                    </div>
                    <div>
                        <span class="text-xs text-muted-foreground uppercase tracking-wider">Duration</span>
                        <p class="text-sm font-semibold mt-1">${timeline.totalDurationMs.toFixed(0)}ms</p>
                    </div>
                    <div>
                        <span class="text-xs text-muted-foreground uppercase tracking-wider">Services</span>
                        <p class="text-sm mt-1">${timeline.services.length}</p>
                    </div>
                    <div>
                        <span class="text-xs text-muted-foreground uppercase tracking-wider">Status</span>
                        <p class="text-sm mt-1">${timeline.hasErrors ? '<span class="text-red-400">Has Errors</span>' : '<span class="text-green-400">Success</span>'}</p>
                    </div>
                </div>`;

            const logs = timeline.logs.map((log, i) => `
                <div class="flex gap-4 group">
                    <div class="w-20 text-right flex-shrink-0">
                        <span class="text-xs text-muted-foreground">+${log.offsetMs.toFixed(0)}ms</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-3 h-3 rounded-full ${log.level >= 4 ? 'bg-red-500' : log.level >= 3 ? 'bg-yellow-500' : 'bg-green-500'} ring-4 ring-background"></div>
                        ${i < timeline.logs.length - 1 ? '<div class="w-0.5 flex-1 bg-border"></div>' : ''}
                    </div>
                    <div class="flex-1 pb-6">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-mono text-xs text-purple-400">${escapeHtml(log.appName)}</span>
                            ${levelBadge(log.level)}
                        </div>
                        <p class="text-sm text-foreground">${escapeHtml(log.message)}</p>
                        ${log.metadata ? `<pre class="mt-2 rounded bg-muted/50 p-2 text-xs font-mono overflow-x-auto">${formatMetadata(log.metadata)}</pre>` : ''}
                    </div>
                </div>
            `).join('');

            details.innerHTML = header + `<div class="mt-6">${logs}</div>`;
        }

        function closeTraceModal() {
            const modal = document.getElementById('traceModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // --- Expand/Collapse Row ---
        function toggleExpand(row, index) {
            const expandRow = document.querySelector(`tr[data-expand="${index}"]`);
            const chevron = row.querySelector('.expand-chevron');
            if (!expandRow) return;

            // Close previously expanded
            if (expandedRow !== null && expandedRow !== index) {
                const prev = document.querySelector(`tr[data-expand="${expandedRow}"]`);
                const prevChevron = document.querySelector(`tr[data-index="${expandedRow}"] .expand-chevron`);
                if (prev) prev.classList.remove('open');
                if (prevChevron) prevChevron.style.transform = '';
            }

            const isOpen = expandRow.classList.contains('open');
            if (isOpen) {
                expandRow.classList.remove('open');
                chevron.style.transform = '';
                expandedRow = null;
            } else {
                expandRow.classList.add('open');
                chevron.style.transform = 'rotate(180deg)';
                expandedRow = index;
            }
        }

        // --- Copy & Filter ---
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard', 'success'));
        }

        function filterByTrace(traceId) {
            document.getElementById('traceIdFilter').value = traceId;
            currentPage = 1;
            loadLogs();
        }

        function viewTraceTimeline(traceId) {
            showTraceTimeline(traceId);
        }

        // --- Modal ---
        function showDetail(log) {
            const modal = document.getElementById('logModal');
            const details = document.getElementById('logDetails');

            let metadataHtml = '<span class="text-muted-foreground text-xs">-</span>';
            try {
                if (log.metadata) {
                    const parsed = typeof log.metadata === 'string' ? JSON.parse(log.metadata) : log.metadata;
                    metadataHtml = `<pre class="rounded-lg bg-muted/50 border border-border p-3 font-mono text-xs overflow-x-auto scrollbar-thin">${JSON.stringify(parsed, null, 2)}</pre>`;
                }
            } catch { metadataHtml = `<pre class="rounded-lg bg-muted/50 border border-border p-3 font-mono text-xs">${escapeHtml(log.metadata)}</pre>`; }

            details.innerHTML = `
                <div class="grid grid-cols-[100px_1fr] gap-2 text-sm">
                    <span class="text-muted-foreground font-medium">ID</span>
                    <span class="font-mono text-xs break-all">${log.id}</span>
                </div>
                <div class="grid grid-cols-[100px_1fr] gap-2 text-sm">
                    <span class="text-muted-foreground font-medium">Timestamp</span>
                    <span>${formatDate(log.timestamp)}</span>
                </div>
                <div class="grid grid-cols-[100px_1fr] gap-2 text-sm">
                    <span class="text-muted-foreground font-medium">Level</span>
                    ${levelBadge(log.level)}
                </div>
                <div class="grid grid-cols-[100px_1fr] gap-2 text-sm">
                    <span class="text-muted-foreground font-medium">App</span>
                    <span class="text-purple-400 font-mono text-xs">${escapeHtml(log.appName)}</span>
                </div>
                <div class="grid grid-cols-[100px_1fr] gap-2 text-sm">
                    <span class="text-muted-foreground font-medium">Host</span>
                    <span class="font-mono text-xs">${escapeHtml(log.host || '-')}</span>
                </div>
                <div class="grid grid-cols-[100px_1fr] gap-2 text-sm">
                    <span class="text-muted-foreground font-medium">Environment</span>
                    ${envBadge(log.environment)}
                </div>
                <div class="grid grid-cols-[100px_1fr] gap-2 text-sm">
                    <span class="text-muted-foreground font-medium">Trace ID</span>
                    <span class="font-mono text-xs">${escapeHtml(log.traceId || '-')}</span>
                </div>
                <div class="border-t border-border pt-3 space-y-2">
                    <p class="text-sm font-medium text-muted-foreground">Message</p>
                    <pre class="rounded-lg bg-muted/50 border border-border p-3 font-mono text-xs whitespace-pre-wrap break-words">${escapeHtml(log.message)}</pre>
                </div>
                <div class="space-y-2">
                    <p class="text-sm font-medium text-muted-foreground">Metadata</p>
                    ${metadataHtml}
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('logModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // --- Keyboard Shortcuts Modal ---
        function openShortcutsModal() {
            const modal = document.getElementById('shortcutsModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeShortcutsModal() {
            const modal = document.getElementById('shortcutsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Quick level filter functions (keyboard shortcuts)
        function setLevelFilter(level) {
            document.querySelectorAll('.level-toggle').forEach(btn => {
                const colors = levelColors[btn.dataset.level];
                if (level === 'all') {
                    btn.classList.remove('active');
                    colors.active.split(' ').forEach(c => btn.classList.remove(c));
                    btn.classList.add('bg-background');
                } else {
                    const match = btn.dataset.level.toLowerCase() === level.toLowerCase();
                    btn.classList.toggle('active', match);
                    if (match) {
                        colors.active.split(' ').forEach(c => btn.classList.add(c));
                        btn.classList.remove('bg-background');
                    } else {
                        colors.active.split(' ').forEach(c => btn.classList.remove(c));
                        btn.classList.add('bg-background');
                    }
                }
            });
            currentPage = 1;
            loadLogs();
        }

        // --- Live Mode ---
        function toggleLive() {
            isLive = !isLive;
            const btn = document.getElementById('liveToggle');
            const dot = document.getElementById('liveDot');

            if (isLive) {
                btn.classList.add('bg-green-500', 'text-black', 'border-green-500');
                btn.classList.remove('text-green-500', 'hover:bg-green-500/10');
                dot.classList.add('animate-ping');
                dot.style.opacity = '0.75';
                currentPage = 1;
                liveInterval = setInterval(loadLogs, 2000);
                showToast('Live mode enabled', 'success');
            } else {
                btn.classList.remove('bg-green-500', 'text-black', 'border-green-500');
                btn.classList.add('text-green-500', 'hover:bg-green-500/10');
                dot.classList.remove('animate-ping');
                dot.style.opacity = '0';
                clearInterval(liveInterval);
                showToast('Live mode disabled', 'info');
            }
        }

        // --- Pagination ---
        function updatePagination() {
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages} (${totalCount.toLocaleString()} logs)`;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
            document.getElementById('firstPage').disabled = currentPage <= 1;
            document.getElementById('lastPage').disabled = currentPage >= totalPages;
            renderPageNumbers();
        }

        function renderPageNumbers() {
            const container = document.getElementById('pageNumbers');
            if (totalPages <= 1) { container.innerHTML = ''; return; }

            const pages = [];
            const maxVisible = 5;

            if (totalPages <= maxVisible + 2) {
                for (let i = 1; i <= totalPages; i++) pages.push(i);
            } else {
                pages.push(1);
                let start = Math.max(2, currentPage - 1);
                let end = Math.min(totalPages - 1, currentPage + 1);
                if (currentPage <= 3) { start = 2; end = maxVisible - 1; }
                if (currentPage >= totalPages - 2) { start = totalPages - maxVisible + 2; end = totalPages - 1; }
                if (start > 2) pages.push('...');
                for (let i = start; i <= end; i++) pages.push(i);
                if (end < totalPages - 1) pages.push('...');
                pages.push(totalPages);
            }

            container.innerHTML = pages.map(p => {
                if (p === '...') return `<span class="h-8 w-6 flex items-center justify-center text-xs text-muted-foreground">...</span>`;
                return `<button onclick="goToPage(${p})" class="page-btn h-8 rounded-md border border-border bg-background px-2 text-xs font-medium text-foreground hover:bg-secondary transition-colors ${p === currentPage ? 'active' : ''}">${p}</button>`;
            }).join('');
        }

        function goToPage(page) {
            currentPage = page;
            loadLogs();
        }

        // --- Clear Filters ---
        function clearAllFilters() {
            // Reset level toggles
            document.querySelectorAll('.level-toggle').forEach(btn => {
                btn.classList.remove('active');
                const colors = levelColors[btn.dataset.level];
                colors.active.split(' ').forEach(c => btn.classList.remove(c));
                btn.classList.add('bg-background');
            });
            document.getElementById('searchFilter').value = '';
            document.getElementById('traceIdFilter').value = '';
            document.getElementById('fromFilter').value = '';
            document.getElementById('toFilter').value = '';
            document.getElementById('projectFilter').value = '';
            document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active-time-range'));
            document.querySelector('.time-range-btn[data-hours="0"]').classList.add('active-time-range');
            const customRow = document.getElementById('customRangeRow');
            customRow.classList.add('hidden');
            customRow.classList.remove('flex');
            currentPage = 1;
            loadLogs();
        }

        // --- Bulk Selection ---
        function toggleLogSelection(checkbox, logId) {
            if (checkbox.checked) {
                selectedLogs.add(logId);
                checkbox.closest('tr').classList.add('bg-primary/10');
            } else {
                selectedLogs.delete(logId);
                checkbox.closest('tr').classList.remove('bg-primary/10');
            }
            updateBulkActionsBar();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.log-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const logId = cb.dataset.id;
                if (checkbox.checked) {
                    selectedLogs.add(logId);
                    cb.closest('tr').classList.add('bg-primary/10');
                } else {
                    selectedLogs.delete(logId);
                    cb.closest('tr').classList.remove('bg-primary/10');
                }
            });
            updateBulkActionsBar();
        }

        function selectAllOnPage() {
            const checkboxes = document.querySelectorAll('.log-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = true;
                selectedLogs.add(cb.dataset.id);
                cb.closest('tr').classList.add('bg-primary/10');
            });
            document.getElementById('selectAllCheckbox').checked = true;
            updateBulkActionsBar();
        }

        function clearSelection() {
            selectedLogs.clear();
            document.querySelectorAll('.log-checkbox').forEach(cb => {
                cb.checked = false;
                cb.closest('tr').classList.remove('bg-primary/10');
            });
            document.getElementById('selectAllCheckbox').checked = false;
            updateBulkActionsBar();
        }

        function updateSelectAllCheckbox() {
            const checkboxes = document.querySelectorAll('.log-checkbox');
            const allChecked = checkboxes.length > 0 && [...checkboxes].every(cb => cb.checked);
            document.getElementById('selectAllCheckbox').checked = allChecked;
        }

        function updateBulkActionsBar() {
            const bar = document.getElementById('bulkActionsBar');
            const count = selectedLogs.size;
            document.getElementById('selectedCount').textContent = count;
            if (count > 0) {
                bar.classList.remove('hidden');
                bar.classList.add('flex');
            } else {
                bar.classList.add('hidden');
                bar.classList.remove('flex');
            }
        }

        function getSelectedLogsData() {
            return currentLogs.filter(log => selectedLogs.has(log.id));
        }

        function copySelectedAsJson() {
            const logs = getSelectedLogsData();
            if (logs.length === 0) {
                showToast('No logs selected', 'error');
                return;
            }
            const json = JSON.stringify(logs, null, 2);
            navigator.clipboard.writeText(json).then(() => {
                showToast(`${logs.length} logs copied as JSON`, 'success');
            });
        }

        function copySelectedAsCsv() {
            const logs = getSelectedLogsData();
            if (logs.length === 0) {
                showToast('No logs selected', 'error');
                return;
            }
            const headers = ['id', 'timestamp', 'level', 'appName', 'environment', 'host', 'message', 'traceId', 'metadata'];
            const levelMap = {0:'Trace', 1:'Debug', 2:'Info', 3:'Warning', 4:'Error', 5:'Fatal'};
            const csvRows = [headers.join(',')];
            logs.forEach(log => {
                const row = [
                    log.id,
                    log.timestamp,
                    levelMap[log.level] || log.level,
                    `"${(log.appName || '').replace(/"/g, '""')}"`,
                    log.environment || '',
                    log.host || '',
                    `"${(log.message || '').replace(/"/g, '""').replace(/\n/g, '\\n')}"`,
                    log.traceId || '',
                    `"${(log.metadata || '').replace(/"/g, '""')}"`
                ];
                csvRows.push(row.join(','));
            });
            navigator.clipboard.writeText(csvRows.join('\n')).then(() => {
                showToast(`${logs.length} logs copied as CSV`, 'success');
            });
        }

        function downloadSelectedAsJson() {
            const logs = getSelectedLogsData();
            if (logs.length === 0) {
                showToast('No logs selected', 'error');
                return;
            }
            const json = JSON.stringify(logs, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `logs-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast(`${logs.length} logs downloaded`, 'success');
        }

        // --- Event Listeners ---
        document.getElementById('refreshBtn').addEventListener('click', loadLogs);
        document.getElementById('liveToggle').addEventListener('click', toggleLive);
        document.getElementById('searchFilter').addEventListener('keyup', debounce(() => { currentPage = 1; loadLogs(); }, 500));
        document.getElementById('traceIdFilter').addEventListener('keyup', debounce(() => { currentPage = 1; loadLogs(); }, 500));
        document.getElementById('fromFilter').addEventListener('change', () => {
            document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active-time-range'));
            currentPage = 1; loadLogs();
        });
        document.getElementById('toFilter').addEventListener('change', () => {
            document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active-time-range'));
            currentPage = 1; loadLogs();
        });
        document.getElementById('projectFilter').addEventListener('change', () => { currentPage = 1; loadLogs(); });
        document.getElementById('clearFilters').addEventListener('click', clearAllFilters);

        document.getElementById('pageSizeSelect').addEventListener('change', (e) => {
            pageSize = parseInt(e.target.value);
            currentPage = 1;
            loadLogs();
        });

        document.getElementById('firstPage').addEventListener('click', () => { currentPage = 1; loadLogs(); });
        document.getElementById('prevPage').addEventListener('click', () => { if (currentPage > 1) { currentPage--; loadLogs(); } });
        document.getElementById('nextPage').addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; loadLogs(); } });
        document.getElementById('lastPage').addEventListener('click', () => { currentPage = totalPages; loadLogs(); });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape always works
            if (e.key === 'Escape') {
                closeModal();
                closeShortcutsModal();
                return;
            }

            // Don't process shortcuts when typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;

            // Help modal
            if (e.key === '?' || (e.shiftKey && e.key === '/')) {
                e.preventDefault();
                openShortcutsModal();
                return;
            }

            // Navigation
            if (e.key === 'ArrowLeft' && currentPage > 1) { currentPage--; loadLogs(); }
            if (e.key === 'ArrowRight' && currentPage < totalPages) { currentPage++; loadLogs(); }
            if (e.key === 'r') loadLogs();

            // Focus search
            if (e.key === '/') {
                e.preventDefault();
                document.getElementById('searchFilter').focus();
            }

            // Toggle live mode
            if (e.key === 'l') toggleLive();

            // Clear filters
            if (e.key === 'c') clearAllFilters();

            // Level filters
            if (e.key === 'e') setLevelFilter('Error');
            if (e.key === 'w') setLevelFilter('Warning');
            if (e.key === 'i') setLevelFilter('Info');
            if (e.key === 'a') setLevelFilter('all');
        });

        // Initial load - first restore state from URL, then load
        loadStateFromUrl();
        loadLogs();
    </script>
}
