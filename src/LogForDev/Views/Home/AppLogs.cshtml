@{
    ViewData["Title"] = "App Logs";
}

<div class="mb-6">
    <h1 class="text-2xl font-bold">Application Logs</h1>
    <p class="text-sm text-muted-foreground mt-1">Internal request and system logs for LogForDev</p>
</div>

<!-- Filters -->
<div class="rounded-lg border border-border bg-card p-4 mb-6 space-y-3">
    <div class="flex flex-col md:flex-row gap-3 items-end">
        <div class="flex flex-col gap-1.5 w-full md:w-auto">
            <label class="text-xs font-medium text-muted-foreground">Level</label>
            <select id="levelFilter" class="h-9 rounded-md border border-input bg-background px-3 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background min-w-[140px]">
                <option value="">All Levels</option>
                <option value="Information">Information</option>
                <option value="Warning">Warning</option>
                <option value="Error">Error</option>
            </select>
        </div>
        <div class="flex flex-col gap-1.5 flex-1 w-full md:w-auto">
            <label class="text-xs font-medium text-muted-foreground">Search</label>
            <input type="text" id="searchFilter" placeholder="Search messages..." class="h-9 rounded-md border border-input bg-background px-3 text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background w-full" />
        </div>
        <button id="refreshBtn" class="h-9 rounded-md bg-primary px-4 text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors whitespace-nowrap">
            Refresh
        </button>
    </div>
    <!-- Time Range -->
    <div class="flex flex-col md:flex-row gap-3 items-end border-t border-border pt-3">
        <div class="flex flex-col gap-1.5 w-full md:w-auto">
            <label class="text-xs font-medium text-muted-foreground">From</label>
            <input type="datetime-local" id="fromFilter" class="h-9 rounded-md border border-input bg-background px-3 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background" />
        </div>
        <div class="flex flex-col gap-1.5 w-full md:w-auto">
            <label class="text-xs font-medium text-muted-foreground">To</label>
            <input type="datetime-local" id="toFilter" class="h-9 rounded-md border border-input bg-background px-3 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background" />
        </div>
        <div class="flex gap-1.5">
            <button onclick="setTimeRange(1)" class="h-9 rounded-md border border-border bg-background px-3 text-xs font-medium text-foreground hover:bg-secondary transition-colors">1h</button>
            <button onclick="setTimeRange(6)" class="h-9 rounded-md border border-border bg-background px-3 text-xs font-medium text-foreground hover:bg-secondary transition-colors">6h</button>
            <button onclick="setTimeRange(24)" class="h-9 rounded-md border border-border bg-background px-3 text-xs font-medium text-foreground hover:bg-secondary transition-colors">24h</button>
            <button onclick="setTimeRange(168)" class="h-9 rounded-md border border-border bg-background px-3 text-xs font-medium text-foreground hover:bg-secondary transition-colors">7d</button>
            <button onclick="setTimeRange(0)" class="h-9 rounded-md border border-border bg-background px-3 text-xs font-medium text-muted-foreground hover:bg-secondary transition-colors">All</button>
        </div>
    </div>
</div>

<!-- Logs Table -->
<div class="rounded-lg border border-border overflow-hidden mb-6">
    <div class="overflow-x-auto scrollbar-thin">
        <table class="w-full text-sm">
            <thead>
                <tr class="border-b border-border bg-muted/50">
                    <th class="h-10 px-4 text-left font-medium text-muted-foreground w-[160px]">Timestamp</th>
                    <th class="h-10 px-4 text-left font-medium text-muted-foreground w-[100px]">Level</th>
                    <th class="h-10 px-4 text-left font-medium text-muted-foreground w-[70px]">Method</th>
                    <th class="h-10 px-4 text-left font-medium text-muted-foreground w-[200px]">Path</th>
                    <th class="h-10 px-4 text-left font-medium text-muted-foreground w-[70px]">Status</th>
                    <th class="h-10 px-4 text-left font-medium text-muted-foreground w-[80px]">Duration</th>
                    <th class="h-10 px-4 text-left font-medium text-muted-foreground">Message</th>
                </tr>
            </thead>
            <tbody id="logsBody">
                <tr>
                    <td colspan="7" class="h-24 text-center text-muted-foreground">Loading logs...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<div class="flex items-center justify-center gap-4">
    <button id="prevPage" class="h-9 rounded-md border border-border bg-background px-4 text-sm font-medium text-foreground hover:bg-secondary transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
        Previous
    </button>
    <span id="pageInfo" class="text-sm text-muted-foreground">Page 1</span>
    <button id="nextPage" class="h-9 rounded-md border border-border bg-background px-4 text-sm font-medium text-foreground hover:bg-secondary transition-colors">
        Next
    </button>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let totalCount = 0;

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleString();
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        function levelBadgeClasses(level) {
            const base = 'inline-flex items-center rounded-md px-2 py-0.5 text-xs font-semibold';
            switch (level) {
                case 'Information': return base + ' bg-blue-500/20 text-blue-400';
                case 'Warning':     return base + ' bg-yellow-500/20 text-yellow-400';
                case 'Error':       return base + ' bg-red-500/20 text-red-400';
                default:            return base + ' bg-zinc-700/50 text-zinc-400';
            }
        }

        function statusBadgeClasses(code) {
            const base = 'inline-flex items-center rounded-md px-2 py-0.5 text-xs font-semibold font-mono';
            if (code >= 500) return base + ' bg-red-500/20 text-red-400';
            if (code >= 400) return base + ' bg-yellow-500/20 text-yellow-400';
            if (code >= 200 && code < 300) return base + ' bg-green-500/20 text-green-400';
            return base + ' bg-zinc-700/50 text-zinc-400';
        }

        function toLocalISOString(date) {
            const pad = n => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        function setTimeRange(hours) {
            const fromEl = document.getElementById('fromFilter');
            const toEl = document.getElementById('toFilter');
            if (hours === 0) {
                fromEl.value = '';
                toEl.value = '';
            } else {
                const now = new Date();
                const from = new Date(now.getTime() - hours * 60 * 60 * 1000);
                toEl.value = toLocalISOString(now);
                fromEl.value = toLocalISOString(from);
            }
            currentPage = 1;
            loadLogs();
        }

        async function loadLogs() {
            const level = document.getElementById('levelFilter').value;
            const search = document.getElementById('searchFilter').value;
            const from = document.getElementById('fromFilter').value;
            const to = document.getElementById('toFilter').value;

            let url = `/api/logs/app?page=${currentPage}&pageSize=50`;
            if (level) url += `&level=${level}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (from) url += `&from=${encodeURIComponent(new Date(from).toISOString())}`;
            if (to) url += `&to=${encodeURIComponent(new Date(to).toISOString())}`;

            try {
                const response = await fetch(url);
                const result = await response.json();
                totalCount = result.totalCount;
                totalPages = result.totalPages;
                renderLogs(result.data);
                updatePageInfo();
            } catch (error) {
                console.error('Failed to load app logs:', error);
            }
        }

        function renderLogs(logs) {
            const tbody = document.getElementById('logsBody');

            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="h-24 text-center text-muted-foreground">No logs found</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => `
                <tr class="border-b border-border hover:bg-muted/50 transition-colors">
                    <td class="px-4 py-2.5 font-mono text-xs text-muted-foreground">${formatDate(log.timestamp)}</td>
                    <td class="px-4 py-2.5"><span class="${levelBadgeClasses(log.level)}">${log.level}</span></td>
                    <td class="px-4 py-2.5 font-mono text-xs font-semibold">${escapeHtml(log.requestMethod)}</td>
                    <td class="px-4 py-2.5 font-mono text-xs text-purple-400 truncate max-w-[200px]">${escapeHtml(log.requestPath)}</td>
                    <td class="px-4 py-2.5"><span class="${statusBadgeClasses(log.statusCode)}">${log.statusCode || '-'}</span></td>
                    <td class="px-4 py-2.5 font-mono text-xs">${log.durationMs ? log.durationMs.toFixed(1) + 'ms' : '-'}</td>
                    <td class="px-4 py-2.5 text-sm truncate max-w-[300px]">${escapeHtml(log.message)}</td>
                </tr>
            `).join('');
        }

        function updatePageInfo() {
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages} (${totalCount.toLocaleString()} logs)`;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }

        document.getElementById('refreshBtn').addEventListener('click', loadLogs);
        document.getElementById('levelFilter').addEventListener('change', () => { currentPage = 1; loadLogs(); });
        document.getElementById('searchFilter').addEventListener('keyup', debounce(() => { currentPage = 1; loadLogs(); }, 500));
        document.getElementById('fromFilter').addEventListener('change', () => { currentPage = 1; loadLogs(); });
        document.getElementById('toFilter').addEventListener('change', () => { currentPage = 1; loadLogs(); });

        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) { currentPage--; loadLogs(); }
        });
        document.getElementById('nextPage').addEventListener('click', () => {
            currentPage++; loadLogs();
        });

        loadLogs();
    </script>
}
